RGSRC = ../../../../
TOPDIR = ../../
include $(TOPDIR)/Rules.mak
include $(TOPDIR)/Config

UCLIBC_DIR:=$(shell (cd ../.. ; /bin/pwd))
ULIBC_GCC=$(TARGET_ARCH)-uclibc-gcc
ULIBC_GCC_H=gcc-uClibc.h

LOCAL_CFLAGS=-Wall -O2

include $(RGMK)

# We want to make $(TARGET_ARCH)-uclibc-gcc in the archconfig stage.
archconfig:: $(ULIBC_GCC)

$(ULIBC_GCC_H): Makefile $(TOPDIR)Config
	@echo "/* this file was autogenerated by make */" > $@
	@echo "#define UCLIBC_TARGET_PREFIX " \"$(TARGET_PREFIX)\" >> $@
	@echo "#define UCLIBC_DEVEL_PREFIX " \"$(DEVEL_PREFIX)\" >> $@
	@echo "#define UCLIBC_BUILD_DIR " \"$(UCLIBC_DIR)\" >> $@
	@echo "#define GCC_BIN " \"$(TARGET_CC)\" >> $@
	@echo "#define LIBGCC_DIR " \"$(LIBGCC_DIR)\" >> $@
	@echo "#define TARGET_ARCH " \"$(TARGET_ARCH)\" >> $@
	@echo "#define DYNAMIC_LINKER " \"$(DYNAMIC_LINKER)\" >> $@
	@echo "#define BUILD_DYNAMIC_LINKER " \"$(UCLIBC_DIR)/lib/$(UCLIBC_LDSO)\" >> $@
ifeq ($(strip $(HAVE_SHARED)),y)
	@echo "#define __UCLIBC_HAS_SHARED__ 1" >> $@
else
	@echo "#undef __UCLIBC_HAS_SHARED__" >> $@
endif
ifeq ($(strip $(UCLIBC_HAS_MMU)),y)
	@echo "#define __UCLIBC_HAS_MMU__ 1" >> $@
else
	@echo "#undef __UCLIBC_HAS_MMU__" >> $@
endif
ifeq ($(strip $(HAS_ELF)),y)
	@echo "#define __HAS_ELF__ 1" >> $@
else
	@echo "#undef __HAS_ELF__" >> $@
endif
ifeq ($(strip $(UCLIBC_CTOR_DTOR)),y)
	@echo "#define __UCLIBC_CTOR_DTOR__ 1" >> $@
ifeq ($(strip $(UCLIBC_PROFILING)),y)
	@echo "#define __UCLIBC_PROFILING__ 1" >> $@
else
	@echo "#undef __UCLIBC_PROFILING__" >> $@
endif
else
	@echo "#undef __UCLIBC_CTOR_DTOR__" >> $@
endif

$(ULIBC_GCC): gcc-uClibc.c $(ULIBC_GCC_H)
	$(CC_FOR_BUILD) $(LOCAL_CFLAGS) --static -o $@ $< $(LOCAL_LDFLAGS)

