TOPDIR=./
include $(TOPDIR)Config
include $(TOPDIR)Rules.mak

SUBDIRS=extra libc libcrypt libnsl libutil

ifeq ($(strip $(HAVE_SHARED)),y)
  SUBDIRS+=ldso
endif

ifeq ($(strip $(UCLIBC_HAS_THREADS)),y)
  SUBDIRS+=libpthread
endif

ifeq ($(strip $(UCLIBC_HAS_FLOATS)),y)
  SUBDIRS+=libm
endif

ifeq ($(strip $(CONFIG_RG_MAIL_SERVER)),y)
  SUBDIRS+=libresolv
endif

# CONFIG_H_CREATE creates a single line of include/bits/uClibc_config.h from
# the token defined in Config inside LIBC_CONFIGS.
CONFIG_H_CREATE=$(if $($1),"\#define __$1__ $(if $(filter-out y,$($1)),\"$($1)\",1)","\#undef __$1__")

H_LIST=$(addprefix $(2)/,$(notdir $(wildcard $(1)/*.h)))

ARCH_BITS=$(CURDIR)/libc/sysdeps/linux/$(LIBC_ARCH)/bits
HEADERS_ARCH_BITS=$(call H_LIST,$(ARCH_BITS),include/bits)

COMMON_BITS=$(CURDIR)/libc/sysdeps/linux/common/bits
HEADERS_COMMON_BITS=$(filter-out $(HEADERS_ARCH_BITS),$(call H_LIST,$(COMMON_BITS),include/bits))

ARCH_SYS=$(CURDIR)/libc/sysdeps/linux/$(LIBC_ARCH)/sys
HEADERS_ARCH_SYS=$(call H_LIST,$(ARCH_SYS),include/sys)

COMMON_SYS=$(CURDIR)/libc/sysdeps/linux/common/sys
HEADERS_COMMON_SYS=$(filter-out $(HEADERS_ARCH_SYS),$(call H_LIST,$(COMMON_SYS),include/sys))

HEADERS_KERNEL=include/asm-generic include/linux include/scsi

# non-standard linux/include/asm-xxx dirs
ifeq ($(ARCH),um)
  ASM_ARCH=i386
else
  ASM_ARCH=$(ARCH)
endif

HEADERS_KERNEL_ASM=include/asm

HEADERS=include/bits/uClibc_config.h \
  $(HEADERS_COMMON_BITS) $(HEADERS_ARCH_BITS) $(HEADERS_COMMON_SYS) \
  $(HEADERS_ARCH_SYS) $(HEADERS_KERNEL) $(HEADERS_KERNEL_ASM) \
  include/bits/sysnum.h

ifdef ULIBC_IN_TOOLCHAIN
  RAMDISK_FIRST_TASKS+=link_toolchain_ulibc_lib
endif

include $(RGMK)

link_toolchain_ulibc_lib:
	$(RG_LN) $(TOOLS_PREFIX)/ulibc/lib .

archconfig:: include/bits $(HEADERS)
	mkdir -p lib

include/bits:
	mkdir -p $@

include/bits/uClibc_config.h: $(TOPDIR)/Config
	@echo "/* Autogenerated by uClibc master makefile */" > $@
	@$(foreach d,$(LIBC_CONFIGS),echo $(call CONFIG_H_CREATE,$d) >> $@;)

include/bits/sysnum.h:
	./extra/scripts/gen_bits_syscall_h.sh > $@

$(HEADERS_COMMON_BITS):
	ln -sfn $(COMMON_BITS)/$(notdir $@) $@

$(HEADERS_ARCH_BITS):
	ln -sfn $(ARCH_BITS)/$(notdir $@) $@

$(HEADERS_COMMON_SYS):
	ln -sfn $(COMMON_SYS)/$(notdir $@) $@

$(HEADERS_ARCH_SYS):
	ln -sfn $(ARCH_SYS)/$(notdir $@) $@

$(HEADERS_KERNEL):
	ln -sfn $(KERNEL_SOURCE)/$@ $@

$(HEADERS_KERNEL_ASM):
	ln -sfn $(KERNEL_SOURCE)/$@-$(ASM_ARCH) $@

